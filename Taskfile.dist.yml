---
version: "3"

includes:
  gotest:
    taskfile: ../taskfiles/gotest.yml
    # optional because the ../taskfiles dir is cloned via bootstrap below
    optional: true
    dir: .
  azurite:
    taskfile: ../taskfiles/azurite.yml
    # optional because the ../taskfiles dir is cloned via bootstrap below
    optional: true
    dir: .

tasks:

  bootstrap:
    desc: bootstrap the development environment
    cmds:
      - |
        GIT_BOOTSTRAP_SH=$(curl -fsSL https://raw.githubusercontent.com/robinbryce/git-bootstrap/refs/heads/main/git-bootstrap.v2.sh)
        sh -c "$GIT_BOOTSTRAP_SH" - clone .
        sh -c "$GIT_BOOTSTRAP_SH" - checkout .

        if [ -f ../go.work ]; then
          echo "go.work exists, you may need to update it"
        else
        cat <<EOF > ../go.work
        go 1.24.4
        use (
        	./go-datatrails-common
        	./go-datatrails-merklelog/massifs
        	./go-datatrails-merklelog/mmr
        	./go-datatrails-serialization/eventsv1
        	./go-datatrails-simplehash
        	./go-merklelog-azure
        	./go-merklelog-provider-testing
        )
        EOF
        fi
        exit 0

  test:
    desc: run all the tests
    cmds:
      - task: test:unit
      - task: test:integration

  test:unit:
    desc: run the unit tests
    cmds:
      - task: gotest:unit

  test:integration:
    cmds:
      - task: azurite:preflight
      - task: gotest:integration
      - task: azurite:stop
